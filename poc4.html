<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSBridge PoC</title>
    <style>
        body { font-family: sans-serif; padding: 12px; }
        button { padding: 8px 14px; margin: 4px; }
        .pluto { background: #4CAF50; color: white; border: none; }
        .irs { background: #2196F3; color: white; border: none; }
        pre {
            border: 1px solid #ccc;
            padding: 8px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 12px;
        }
        h4 { margin: 15px 0 8px 0; color: #333; }
    </style>
</head>
<body>
<h3>JSBridge PoC</h3>

<h4>ğŸŸ¢ PLUTO åè®® (jsCallNative) - é€šè¿‡ WebViewJavascriptBridge å›è°ƒ</h4>
<button class="pluto" onclick="pluto_getUserInfo()">getUserInfo</button>

<h4>ğŸ”µ IRS åè®® (ihrbridge://) - é€šè¿‡ IrsJSBridge å›è°ƒ</h4>
<button class="irs" onclick="irs_openCamera()">openCamera</button>

<h4>ğŸ“‹ æ—¥å¿—</h4>
<button onclick="document.getElementById('log').textContent=''">æ¸…ç©º</button>
<button onclick="detectEnv()">æ£€æµ‹ç¯å¢ƒ</button>
<pre id="log"></pre>

<script>
    var cbId = 0;

    function log(msg) {
        var el = document.getElementById('log');
        el.textContent += '[' + new Date().toLocaleTimeString() + '] ' + msg + '\n';
        el.scrollTop = el.scrollHeight;
    }

    function getCallbackId() {
        return 'cb_' + (++cbId) + '_' + Date.now();
    }

    // ========== PLUTO å›è°ƒï¼ˆéœ€è¦é€šè¿‡ Hook æ‹¦æˆªï¼‰==========

    function nativeCallback(data) {
        log('[PLUTO å›è°ƒ] ' + data);
    }

    // ========== IRS å›è°ƒ ==========

    var IrsJSBridge = {
        handleMessageFormNative: function(jsonStr) {
            log('[IRS å›è°ƒ] ' + jsonStr);
        }
    };

    // ========== å…³é”®ï¼šHook WebViewJavascriptBridge._handleMessageFromNative ==========

    (function setupHookLoop() {
        function hookOnce() {
            if (!window.WebViewJavascriptBridge) {
                return;
            }
            var bridge = window.WebViewJavascriptBridge;
            var old = bridge._handleMessageFromNative;

            if (typeof old === 'function' && !old.__patched) {
                var wrapped = function(jsonStr) {
                    log('[HOOK] _handleMessageFromNative è¢«è°ƒç”¨: ' + jsonStr);
                    try {
                        var msg = JSON.parse(jsonStr);
                        // æ ¹æ® responseId åˆ†å‘åˆ°å¯¹åº”çš„å›è°ƒå‡½æ•°
                        if (msg && msg.responseId) {
                            var callbackName = msg.responseId;
                            log('[HOOK] responseId=' + callbackName);
                            
                            // å¦‚æœæ˜¯æˆ‘ä»¬æ³¨å†Œçš„å›è°ƒ
                            if (callbackName === 'nativeCallback') {
                                nativeCallback(msg.responseData);
                            } else if (typeof window[callbackName] === 'function') {
                                window[callbackName](msg.responseData);
                            }
                        }
                    } catch (e) {
                        log('[HOOK] è§£æå‡ºé”™: ' + e);
                    }
                    return old.apply(this, arguments);
                };
                wrapped.__patched = true;
                bridge._handleMessageFromNative = wrapped;
                log('[HOOK] âœ… å·²æŒ‚è½½ _handleMessageFromNative æ‹¦æˆªå™¨');
            }
        }

        // ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åæ¯ 500ms é‡è¯•ï¼ˆé˜²æ­¢è¢«è¦†ç›–ï¼‰
        hookOnce();
        setInterval(hookOnce, 500);
    })();

    // ========== ç¯å¢ƒæ£€æµ‹ ==========

    function detectEnv() {
        log('===== ç¯å¢ƒæ£€æµ‹ =====');
        log('window.Android: ' + (window.Android ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
        if (window.Android) {
            log('  - jsCallNative: ' + (typeof Android.jsCallNative));
            log('  - H2C_JSBridge: ' + (typeof Android.H2C_JSBridge));
        }
        log('window.WebViewJavascriptBridge: ' + (window.WebViewJavascriptBridge ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
        if (window.WebViewJavascriptBridge) {
            log('  - _handleMessageFromNative: ' + (typeof WebViewJavascriptBridge._handleMessageFromNative));
            var patched = WebViewJavascriptBridge._handleMessageFromNative && 
                          WebViewJavascriptBridge._handleMessageFromNative.__patched;
            log('  - HookçŠ¶æ€: ' + (patched ? 'âœ… å·²æŒ‚è½½' : 'âŒ æœªæŒ‚è½½'));
        }
    }

    // ========== PLUTO åè®® ==========

    function pluto_getUserInfo() {
        log('--- [PLUTO] getUserInfo ---');
        try {
            if (!window.Android || typeof Android.jsCallNative !== 'function') {
                log('é”™è¯¯: Android.jsCallNative ä¸å­˜åœ¨');
                return;
            }
            var payload = {
                method: 'getUserInfo',
                data: {}
            };
            Android.jsCallNative(JSON.stringify(payload), 'nativeCallback');
            log('å·²è°ƒç”¨ï¼Œç­‰å¾… WebViewJavascriptBridge å›è°ƒ...');
        } catch (e) {
            log('è°ƒç”¨å¼‚å¸¸: ' + e);
        }
    }

    // ========== IRS åè®® ==========

    function irs_openCamera() {
        log('--- [IRS] openCamera ---');
        var id = getCallbackId();
        var params = JSON.stringify({
            handlerName: 'openCamera',
            isOpenAlbum: false
        });
        var url = 'ihrbridge://' + id + '/openCamera?' + params;
        log('URL: ' + url);

        var iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        document.body.appendChild(iframe);
        setTimeout(function() {
            document.body.removeChild(iframe);
        }, 100);
        log('å·²è§¦å‘ï¼Œç­‰å¾… IrsJSBridge å›è°ƒ...');
    }

    // ========== é¡µé¢åŠ è½½ ==========

    window.onload = function() {
        log('é¡µé¢å·²åŠ è½½');
        log('');
        detectEnv();
    };
</script>
</body>
</html>
