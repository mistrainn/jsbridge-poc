<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSBridge PoC (minimal)</title>
    <style>
        body { font-family: sans-serif; padding: 12px; }
        button { padding: 6px 12px; margin-bottom: 10px; }
        pre {
            border: 1px solid #ccc;
            padding: 8px;
            min-height: 80px;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
<h3>JSBridge PoC 测试</h3>
<button onclick="callGetUserInfo()">调用 getUserInfo (同步)</button>
<button onclick="callOpenCamera()">调用 openCamera (异步)</button>
<pre id="log"></pre>

<script>
    function log(msg) {
        var el = document.getElementById('log');
        el.textContent += msg + '\n';
    }

    // 通用的回调处理函数
    function nativeCallback(data) {
        log('[nativeCallback] 收到数据: ' + data);
    }

    // 调用 getUserInfo
    function callGetUserInfo() {
        log('--- 开始调用 getUserInfo ---');
        try {
            if (!window.Android || typeof Android.jsCallNative !== 'function') {
                log('!!! Android.jsCallNative 不存在，当前 window.Android = ' + String(window.Android));
                return;
            }

            var payload = {
                method: 'getUserInfo',
                data: {}
            };

            Android.jsCallNative(JSON.stringify(payload), 'nativeCallback');
            log('已调用 Android.jsCallNative("getUserInfo", "nativeCallback")，等待回调...');
        } catch (e) {
            log('调用异常: ' + e);
        }
    }

    // 调用 openCamera
    function callOpenCamera() {
        log('--- 开始调用 openCamera ---');
        log('提示: openCamera 是异步操作，相机被调起后，需要你拍照或取消才会有回调。');
        try {
            if (!window.Android || typeof Android.jsCallNative !== 'function') {
                log('!!! Android.jsCallNative 不存在，当前 window.Android = ' + String(window.Android));
                return;
            }

            var payload = {
                method: 'openCamera',
                data: {}
            };

            Android.jsCallNative(JSON.stringify(payload), 'nativeCallback');
            log('已调用 Android.jsCallNative("openCamera", "nativeCallback")，等待回调...');
        } catch (e) {
            log('调用异常: ' + e);
        }
    }

    // 周期性 Hook _handleMessageFromNative，避免被后注入的 JS 覆盖
    (function setupHookLoop() {
        function hookOnce() {
            if (!window.WebViewJavascriptBridge) {
                return;
            }
            var bridge = window.WebViewJavascriptBridge;
            var old = bridge._handleMessageFromNative;

            if (typeof old === 'function' && !old.__patched) {
                var wrapped = function(jsonStr) {
                    log('[HOOK] _handleMessageFromNative 被调用: ' + jsonStr);
                    try {
                        var msg = JSON.parse(jsonStr);
                        if (msg && msg.responseId === 'nativeCallback') {
                            log('[HOOK] 匹配到 responseId=nativeCallback，转给 nativeCallback');
                            nativeCallback(msg.responseData);
                        }
                    } catch (e) {
                        log('[HOOK] 解析 jsonStr 出错: ' + e);
                    }
                    return old.apply(this, arguments);
                };
                wrapped.__patched = true;
                bridge._handleMessageFromNative = wrapped;
                log('[HOOK] 已挂载 _handleMessageFromNative 拦截器');
            }
        }

        // 尽早、并每 500ms 尝试重新挂一次（防止被重新注入覆盖）
        hookOnce();
        setInterval(hookOnce, 500);
    })();

    // 页面加载完打印当前环境
    window.onload = function () {
        log('页面已加载完毕');
        log('window.Android: ' + String(window.Android));
        log('window.WebViewJavascriptBridge: ' + String(window.WebViewJavascriptBridge));
    };
</script>
</body>
</html>
